<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>File Uploads</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="../../yadadocs.css" />
</head>
<body class="article toc2 toc-left">
<!--
	Edit the /YadaDocs/src/docs/asciidoc/common/docinfo-header.html file
	to change this menu.
-->

<select id="navigator">
	<option>Choose chapter...</option>
	<option data-link="./index.html">Index</option>
	<option data-link="./newEclipseProject.html">Getting started</option>
	<option data-link="./examples/bookstoreTutorial.html">Bookstore tutorial</option>
	<option data-link="./internationalization.html">Internationalization</option>
	<option data-link="./database/pagination.html">Database pagination</option>
	<option data-link="./forms/overview.html">Forms</option>
	<option data-link="./ajax.html">Ajax</option>
	<option data-link="./ajaxModal.html">Ajax Modal</option>
	<option data-link="./security/overview.html">Security</option>
	<option data-link="./datatables.html">DataTables</option>
	<option data-link="./emails.html">Sending Emails</option>
	<option data-link="./confirmationModal.html">Confirmation Modal</option>
	<option data-link="./notificationModal.html">Notification Modal</option>
	<option data-link="./misc.html">Miscellaneous</option>
	<option data-link="./troubleshooting.html">Troubleshooting</option>
	<option data-link="./upgrade.html">Upgrade Yada Framework Version</option>
</select>
<button id="backToTopButton" onclick="scrollToTop()"><i class="fa fa-arrow-up" aria-hidden="true"></i></button>

<script>
document.querySelector("#navigator").addEventListener("change", function (event) {
	const goup = location.href.lastIndexOf("/") - location.href.lastIndexOf("/en") > 3;
	const link = (goup?"../":"") + this.options[this.selectedIndex].getAttribute("data-link");
	if (link!=null) {
		document.location.href = link;
	}
});

/* Make headers clickable to copy the url */
document.addEventListener('DOMContentLoaded', function () {
    const headers = document.querySelectorAll('h1, h2, h3, h4, h5, h6');

    headers.forEach(header => {
        header.style.cursor = 'pointer';
        header.addEventListener('click', function () {
            const url = window.location.href.split('#')[0] + '#' + this.id;
            window.location.href = url;
        });
    });

});

function scrollToTop() {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
}
/* Only show the backToTopButton when scrolled 200px from the top */
let visible = false;
window.onscroll = function() {
    if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
    	if (!visible) {
	        document.getElementById("backToTopButton").style.display = "block";
	        visible = true;
    	}
    } else {
    	if (visible) {
	        document.getElementById("backToTopButton").style.display = "none";
			visible = false;
    	}
    }
};
</script>
<div id="header">
<h1>File Uploads</h1>
<div class="details">
<span id="revnumber">version 0.7.7</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_description">Description</a></li>
<li><a href="#_configuration">Configuration</a>
<ul class="sectlevel2">
<li><a href="#_maximum_file_size_setting">Maximum file size setting</a></li>
<li><a href="#_maximum_file_size_check">Maximum file size check</a></li>
</ul>
</li>
<li><a href="#_html">HTML</a>
<ul class="sectlevel2">
<li><a href="#_form_fragment_yadaformfileupload">Form Fragment /yada/form/fileUpload</a></li>
</ul>
</li>
<li><a href="#_java">JAVA</a>
<ul class="sectlevel2">
<li><a href="#_just_save_the_file">Just save the file</a></li>
<li><a href="#_yadaattachedfile">YadaAttachedFile</a></li>
<li><a href="#_yadafilemanager">YadaFileManager</a></li>
</ul>
</li>
<li><a href="#_image_upload_and_crop">Image upload and crop</a>
<ul class="sectlevel2">
<li><a href="#_workflow">Workflow</a></li>
<li><a href="#_prerequisites">Prerequisites</a></li>
<li><a href="#_configuration_2">Configuration</a></li>
<li><a href="#_java_form_bean">Java form bean</a></li>
<li><a href="#_html_form">HTML form</a></li>
<li><a href="#_java_controller_to_show_the_form">Java Controller to show the form</a></li>
<li><a href="#_java_form_submission">Java Form submission</a></li>
<li><a href="#_html_crop_page">HTML Crop page</a></li>
<li><a href="#_troubleshooting">Troubleshooting</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Uploading files to the server, handling and linking them</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>File Upload is handled via the standard Servlet API.</p>
</div>
<div class="paragraph">
<p>YadaFramework offers some utility classes to more easily handle files <em>after</em> they have been uploaded:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>storing files on disk</p>
</li>
<li>
<p>resizing images</p>
</li>
<li>
<p>assigning files to Entity objects</p>
</li>
<li>
<p>generating download links</p>
</li>
<li>
<p>managing the pool of uploaded files</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This section shows how to upload files via plain form submission (ajax or not).
For a way to upload by dragging, see <a href="../ajax.html#_ajax_upload_by_dragdrop">Ajax upload by drag&amp;drop</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration">Configuration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_maximum_file_size_setting">Maximum file size setting</h3>
<div class="paragraph">
<p>You can set the maximum file size for an upload by means of the <code>maxFileUploadSizeBytes</code> configuration entry:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;config&gt;
	&lt;maxFileUploadSizeBytes&gt;3000000&lt;/maxFileUploadSizeBytes&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default is 50MB.</p>
</div>
</div>
<div class="sect2">
<h3 id="_maximum_file_size_check">Maximum file size check</h3>
<div class="paragraph">
<p>When the upload limit is reached, a message is logged with a debug severity.
You can ensure to see the message with the following logback configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;logger name="org.springframework.web.multipart.commons.YadaCommonsMultipartResolver" level="DEBUG"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A Request Attribute is also added to the Request with the name <code>MaxUploadSizeExceededException</code> and
the MaxUploadSizeExceededException as a value.
<strong>All Request Parameters sent with the form are lost.</strong></p>
</div>
<div class="paragraph">
<p>The Java method</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">YadaCommonsMultipartResolver.limitExceeded(request)</code></pre>
</div>
</div>
<div class="paragraph">
<p>can be used in a @Controller to take appropriate action when the file limit is exceeded, for example by returning an error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">if (YadaCommonsMultipartResolver.limitExceeded(request)) {
	yadaNotify.title("News not saved", model).error().message("File too big. Size limit is " + config.getMaxFileUploadSizeBytes()/(1024*1024) + " MB").add();
    return "/cms/news";
}</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>On an ajax POST, anything returned by the @Controller is discarded and the user only sees a generic error message.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The following may not be true anymore:</p>
</div>
<div class="paragraph">
<p>By default, Tomcat will also drop the connection and no response will be sent to the browser. This will result in a low-level error shown by the browser.
The reason for this is explained <a href="https://www.mkyong.com/spring/spring-file-upload-and-connection-reset-issue/">here</a> and can only avoided if you configure Tomcat not to drop the connection but keep uploading any excess data (<code>maxSwallowSize="-1"</code>).
The drawback would be that network bandwidth would be wasted and the user will have to wait until the whole file is uploaded before being told that it was too big.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The best solution would be to check file size on the browser via javascript. This is not currently implemented in Yada but is something like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">function fileTooBig() {
    var file = $('input[name=attachment]')[0].files[0];
    if (file==null) {
            return false;
    }
    var sizeMega = file.size/1024/1024;
    if (sizeMega&gt;3) {
            $('#fileTooBig').show();
            return true;
    }
    $('#fileTooBig').hide();
    return false;
}
$('input[name=attachment]').on('change', function() {
    fileTooBig();
});
$('#theForm').submit(function() {
    if (fileTooBig()) {
            event.preventDefault();
    }
});</code></pre>
</div>
</div>
<div class="listingblock todo">
<div class="content">
<pre>Automate javascript checking of file size</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_html">HTML</h2>
<div class="sectionbody">
<div class="paragraph">
<p>File upload starts from a <code>"multipart/form-data"</code> form. This is a standard form with a input element of type <code>"file"</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;form method="POST" enctype="multipart/form-data" action="doUpload"&gt;
    File to upload: &lt;input type="file" name="upfile"&gt;&lt;br/&gt;
    &lt;button type="submit"&gt;Upload&lt;/button&gt;
&lt;/form&gt;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_form_fragment_yadaformfileupload">Form Fragment /yada/form/fileUpload</h3>
<div class="paragraph">
<p>If you&#8217;re using a  <em>form backing bean</em> you can include a yada fragment for the input tag.
The following example also shows any error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;form th:action="@{/profile}" th:object="${formProfile}" enctype="multipart/form-data" method="post"
th:classappend="${#fields.hasErrors('*')}? has-error" role="form"&gt;

    &lt;div th:replace="/yada/form/fileUpload::field(fieldName='avatarImage',label='Avatar')"&gt;&lt;/div&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can display a link to the uploaded file underneath the input field by passing an instance of <code>YadaAttachedFile</code> to the <code>attachedFile</code> fragment attribute.
For other usage instructions see the source file for <code>/yada/form/fileUpload</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_java">JAVA</h2>
<div class="sectionbody">
<div class="paragraph">
<p>After submission, the uploaded file will be processed by  <em>Commons File Upload</em> and sent to the @Controller as a <code>MultipartFile</code> object.
You would normally add a field of that type to the  <em>form backing bean</em>, but you can also handle it independently from the other form fields if you wish,
by adding it to the @RequestMapping signature.</p>
</div>
<div class="paragraph">
<p>In the @Controller you have many options.</p>
</div>
<div class="sect2">
<h3 id="_just_save_the_file">Just save the file</h3>
<div class="paragraph">
<p>You can just save the file somewhere with YadaWebUtil.saveAttachment():</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public String storeFile(MultipartFile submittedFile) {
    File destination = new File("someFolder");
    YadaWebUtil.saveAttachment(submittedFile, destination):</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you will have to keep track of the file yourself somehow. The following sections show an alternative and more convenient way of dealing with file uploads.</p>
</div>
</div>
<div class="sect2">
<h3 id="_yadaattachedfile">YadaAttachedFile</h3>
<div class="paragraph">
<p>Usually the uploaded file has to be associated to some Entity in the database: a user avatar or CV, the image of a product, the pdf for a trip.
Use YadaAttachedFile to easily handle file attachments:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Entity
public class Product {
    @OneToOne(cascade=CascadeType.PERSIST)
    protected YadaAttachedFile icon;

    @OneToOne(cascade=CascadeType.PERSIST)
    protected YadaAttachedFile specSheet;</code></pre>
</div>
</div>
<div class="paragraph">
<p>After doing this you can make use of the functionality of YadaFileManager explained below.
You shouldn&#8217;t use any <code>cascade</code> different from PERSIST or <code>orphanRemoval</code> annotations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>cascade <code>SAVE</code> would generate a <code>ConcurrentModificationException</code> when using the upload and crop workflow (images only - see below)</p>
</li>
<li>
<p>cascade <code>REMOVE</code> or <code>orphanRemoval=true</code> wouldn&#8217;t delete the file on disk</p>
</li>
<li>
<p>cascade <code>PERSIST</code> is needed when cloning the parent object (<code>Product</code> in the example above)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The YadaAttachedFile class stores some file-related information that you might want to keep:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the original name of the file uploaded by the user</p>
</li>
<li>
<p>the upload time</p>
</li>
<li>
<p>localized title and description</p>
</li>
<li>
<p>the folder where the file is stored</p>
</li>
<li>
<p>the name of three versions of the file: the original one and the ones scaled for desktop and mobile</p>
</li>
<li>
<p>the sort order relative to files of the same "group"</p>
</li>
<li>
<p>a "published" flag</p>
</li>
<li>
<p>a locale if the file has to be made available only to some specific locale. This could be useful for pdf files in different languages</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_yadafilemanager">YadaFileManager</h3>
<div class="sect3">
<h4 id="_introduction">Introduction</h4>
<div class="paragraph">
<p>The YadaFileManager @Service is the single entry to all operations on uploaded files stored as YadaAttachedFile.</p>
</div>
<div class="paragraph">
<p>Every time a file is uploaded, it is stored in a folder named "uploads" in the &lt;basePath&gt; configured directory. This folder is
created automatically if the tomcat process has enough permissions, otherwise you have to create it manually.</p>
</div>
</div>
<div class="sect3">
<h4 id="_saving_the_file">Saving the file</h4>
<div class="paragraph">
<p>Every file is stored using the original file name. To prevent name duplicates a number is automatically appended at the end.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public String updateProfile(MultipartFile uploadedMultipart) {
    File uploadedFile = yadaFileManager.uploadFile(uploadedMultipart);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The File can then be attached to an Entity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">YadaAttachedFile newIcon = yadaFileManager.attachNew(uploadedFile, uploadedMultipart, "/userData", "icon");
if (newIcon!=null) {
    user.setIcon(newIcon);
    userRepository.save(user);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>yadaFileManager.uploadFile()</code> call can be skipped when passing the MultipartFile directly to <code>attachNew()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">YadaAttachedFile newIcon = yadaFileManager.attachNew(uploadedMultipart, "/userData", "icon");</code></pre>
</div>
</div>
<div class="paragraph">
<p>The association between the owning Entity and the new YadaAttachedFile instance is not created automatically by yadaFileManager.attachNew() and you
have to do it explicitly as shown above.
When the attach method is called, the original uploaded file is copied from the "uploads" folder into the target folder.
The new file will have the new prefix specified and the YadaAttachedFile id at the end of the name.
The original file is by default deleted from the "uploads" folder unless a specific configuration is set to false:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;yadaFileManager&gt;
    &lt;deleteUploads&gt;false&lt;/deleteUploads&gt;
&lt;/yadaFileManager&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Not deleting uploaded files allows the implementation of a filesystem-like feature where single files could be reused many times.</p>
</div>
<div class="listingblock todo">
<div class="content">
<pre>implement filesystem feature</pre>
</div>
</div>
<div class="paragraph">
<p>In case you&#8217;re replacing a previous attachment, you only need to pass the previous YadaAttachedFile: the old files will be deleted and replaced with
the new ones. No explicit database operation is needed in this case.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">YadaAttachedFile previousIcon = user.getIcon();
YadaAttachedFile iconAttachedFile = yadaFileManager.attachReplace(previousIcon, uploadedFile, "icon", "jpg", null, null);</code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The difference between <code>attachNew()</code> and <code>attachReplace()</code> is that the former creates a new YadaAttachedFile instance each time and adds it to the database while
the latter reuses the existing instance.
If you use the attachNew method to replace an existing file, you will have to delete the old YadaAttachedFile object yourself so it&#8217;s better to use attachReplace in this scenario.
AttachNew should be used on the first upload of a file or when an Entity can hold a list of files.
There is no way to detect if you are using the wrong method, so be careful.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Complete Example</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">/**
 * Uploads an "icon" image for the user
 */
public String updateProfile(MultipartFile uploadedMultipart) {
	... fetch 'user' somehow ...
    if (uploadedMultipart!=null &amp;&amp; !uploadedMultipart.isEmpty()) {
        YadaAttachedFile previousIcon = user.getIcon();
        if (previousIcon==null) {
            // Move the file to the "someFolder" directory and create a new YadaAttachedFile
            YadaAttachedFile newIcon = yadaFileManager.attachNew(uploadedMultipart, "/someFolder", "myprefix");
            if (newIcon!=null) {
                user.setIcon(newIcon);
                userRepository.save(user);
            }
        } else {
            // Replace the existing file with the uploaded one
            yadaFileManager.attachReplace(previousIcon, uploadedMultipart, "myprefix", "jpg", null, null);
        }
    }</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_image_variants">Image variants</h4>
<div class="paragraph">
<p>If the uploaded file is an image, it can be resized for desktop and mobile as needed by specifying the alternative dimensions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">yadaFileManager.attach(uploadedFile, "userData", "icon", "jpg", 1280, 768);</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example the image is converted to jpg and two additional versions are saved on disk.
The conversion is performed with the command line tool configured in <code>config/shell/resize</code> (usually imagemagick).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To keep things simple, there are no high density versions for mobile: you should just use the desktop version.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock todo">
<div class="content">
<pre>link to the configuration section</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_file_url">File URL</h4>
<div class="paragraph">
<p>In order to show images and allow file download, you need to add the relevant URL to the page.
This is done by the methods <code>YadaFileManager.getFileUrl()</code>, <code>YadaFileManager.getDesktopImageUrl()</code>, <code>YadaFileManager.getMobileImageUrl()</code> that can
either be used in the @Controller or directly in the HTML:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;img th:src="@{${@yadaFileManager.getDesktopImageUrl(user.icon)}}"&gt;
&lt;a th:href="@{${@yadaFileManager.getFileUrl(product.manual)}}"&gt;Download manual&lt;/a&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you call <code>getMobileImageUrl()</code> and a mobile image is not present, it will fall back to <code>getDesktopImageUrl()</code> which in turn
falls back to <code>getFileUrl()</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_copy_files">Copy Files</h4>
<div class="paragraph">
<p>When you duplicate an Entity you also need to duplicate the files on the filesystem using <code>YadaFileManager.duplicateFiles()</code> otherwise the
new entity will reference the old files.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">ConfiguratorShape clone = configuratorDao.copy(configuratorShape);
yadaFileManager.duplicateFiles(clone.getIcon());</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is <strong>not needed</strong> if the copy is done with <code>YadaUtil.copyEntity()</code> because the file on disk is also copied automatically.</p>
</div>
</div>
<div class="sect3">
<h4 id="_delete_files">Delete Files</h4>
<div class="paragraph">
<p>Files can be removed from the filesystem with <code>YadaFileManager.deleteFileAttachment()</code>. All database objects must then be deleted manually.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">YadaAttachedFile icon = user.getIcon();
yadaFileManager.deleteFileAttachment(icon);
user.setIcon(null); // Remove relationship before deletion
user = userDao.save(user);
yadaAttachedFileDao.delete(icon);</code></pre>
</div>
</div>
<div class="listingblock todo">
<div class="content">
<pre>test that the above code works</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_image_upload_and_crop">Image upload and crop</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_workflow">Workflow</h3>
<div class="paragraph">
<p>Usually images that users upload must be of a specific size and can be in (up to) two versions, one for desktop layout and another for mobile layout.
Currently there is no specific image for tablet layout (use the desktop one) of for high density mobiles.</p>
</div>
<div class="paragraph">
<p>The upload form should specify the required size and should reject any smaller image.
Bigger images should be allowed regardless of their proportions and should be cropped by the user if needed. Finally, the image has to
be resized (reduced) to the target dimensions.</p>
</div>
<div class="paragraph">
<p>This is implemented by storing an instance of YadaCropQueue in the session, and starting a loop that asks the user to
crop all images added to the queue until there are no more left.</p>
</div>
</div>
<div class="sect2">
<h3 id="_prerequisites">Prerequisites</h3>
<div class="paragraph">
<p><a href="https://imagemagick.org/index.php">Imagemagick</a> must be installed on the system.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_2">Configuration</h3>
<div class="paragraph">
<p>The required image size has to be configured in the <code>conf.webapp.prod.xml</code> file, as in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;config&gt;
    &lt;dimension targetImageExtension="jpg" preserveImageExtensions="gif"&gt;
        &lt;news&gt;
            &lt;top&gt;
                &lt;desktop&gt;1920,1200&lt;/desktop&gt;
                &lt;mobile&gt;768,610&lt;/mobile&gt;
                &lt;pdf&gt;3840,2400&lt;/pdf&gt;
            &lt;/top&gt;
            &lt;thumbnail&gt;
                &lt;desktop&gt;800,800&lt;/desktop&gt;
                &lt;mobile&gt;400,400&lt;/mobile&gt;
                &lt;pdf&gt;2000,2000&lt;/pdf&gt;
            &lt;/thumbnail&gt;
        &lt;/news&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>targetImageExtension</code> is the image format that all uploaded images will be converted to, unless specified
in <code>preserveImageExtensions</code> which is a comma-separated list of extensions that should not be converted.
This can be useful to preserve animated gifs.
Then the desktop/mobile/PDF dimensions required for each image are specified, but all are optional.
In this example there is one "news" image in three cropped sizes, one named "top" and another named "thumbnail".
There&#8217;s no need to specify all the three dimensions (desktop/mobile/PDF), but at least one is required
to make any sense of the crop operation.
The above configuration can be read in your subclass of <code>YadaConfiguration</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public YadaIntDimension[] getDimensionsNewsThumbnail() {
    return super.getImageDimensions("/news/thumbnail");
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will return an array of YadaIntDimension holding the desktop, mobile and PDF dimensions at position 0, 1 and 2,
with a null value when the dimension has not been configured.</p>
</div>
<div class="paragraph">
<p>The command to crop and resize images must be specified in the configuration too.
This example can crop and resize any image, preserving animated gifs if the gif extension has been included in the preserveImageExtensions attribute.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;config&gt;
    &lt;shell&gt;
        &lt;yadaCropAndResize timeoutseconds="20"&gt;
            &lt;executable&gt;convert&lt;/executable&gt;
            &lt;arg&gt;${FILENAMEIN}&lt;/arg&gt;
            &lt;arg&gt;-coalesce&lt;/arg&gt;
            &lt;arg&gt;-repage&lt;/arg&gt;
            &lt;arg&gt;0x0&lt;/arg&gt;
            &lt;arg&gt;-crop&lt;/arg&gt;
            &lt;arg&gt;${w}x${h}+${x}+${y}&lt;/arg&gt;
            &lt;arg&gt;-resize&lt;/arg&gt;
            &lt;arg&gt;${resizew}x${resizeh}&amp;gt;&lt;/arg&gt;
            &lt;arg&gt;+repage&lt;/arg&gt;
            &lt;arg&gt;${FILENAMEOUT}&lt;/arg&gt;
        &lt;/yadaCropAndResize&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example works with any image but corrupts gif animations.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;yadaCropAndResize timeoutseconds="20"&gt;
    &lt;executable&gt;convert&lt;/executable&gt;
    &lt;arg&gt;${FILENAMEIN}&lt;/arg&gt;
    &lt;arg&gt;-background&lt;/arg&gt; &lt;!-- "-background white -flatten" converts any transparent png backround to white instead of the default black --&gt;
    &lt;arg&gt;white&lt;/arg&gt;
    &lt;arg&gt;-flatten&lt;/arg&gt;
    &lt;arg&gt;-crop&lt;/arg&gt;
    &lt;arg&gt;${w}x${h}+${x}+${y}&lt;/arg&gt;
    &lt;arg&gt;-resize&lt;/arg&gt;
    &lt;arg&gt;${resizew}x${resizeh}&amp;gt;&lt;/arg&gt;
    &lt;arg&gt;${FILENAMEOUT}&lt;/arg&gt;
&lt;/yadaCropAndResize&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Be aware that the most recent version of imagemagick uses the "magick" command instead of "convert", which must become the first argument:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;executable&gt;magick&lt;/executable&gt;
&lt;arg&gt;convert&lt;/arg&gt;
&lt;arg&gt;${FILENAMEIN}&lt;/arg&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more details on shell command executions, see <a href="../misc.html#_shell_command_execution">Shell Command Execution</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_java_form_bean">Java form bean</h3>
<div class="paragraph">
<p>The easiest way to handle file uploads is to use the <a href="overview.html#_entity_backing_beans">Entity Backing Beans</a> technique. You need to add a <code>@Transient</code> field (with getter and setter)
for each multipart file you need to receive:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Entity
public class News implements CloneableDeep {
    @OneToOne(cascade=CascadeType.PERSIST)
    protected YadaAttachedFile thumbnail;

    @Transient
    private  MultipartFile thumbnailImage;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This allows for easy validation and handling of the uploaded file.
You can also use a <a href="overview.html#_form_backing_beans">Form Backing Bean</a> of course.</p>
</div>
</div>
<div class="sect2">
<h3 id="_html_form">HTML form</h3>
<div class="paragraph">
<p>The upload form can be as simple as a plain file input (here with spring/bootstrap5 validation added):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;form th:action="@{/addOrUpdateNews}" th:object="${news}" enctype="multipart/form-data"
	method="post" role="form" th:with="hasError=${#fields.hasErrors('myFieldName')}"&gt;
	&lt;input type="file" name="myFieldName" accept="image/*" th:classappend="${hasError}?is-invalid"&gt;
	&lt;div th:each="err : ${#fields.errors('myFieldName')}" th:text="${err}" class="invalid-feedback"&gt;Invalid image&lt;/div&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The form can also be implemented using the <code>/yada/form/fileUpload</code> fragment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;form th:action="@{/addOrUpdateNews}" th:object="${news}" enctype="multipart/form-data" th:classappend="${#fields.hasErrors('*')}? has-error" method="post" role="form"&gt;
    &lt;div th:replace="/yada/form/fileUpload::field(fieldName='thumbnailImage',size=${thumbnailSize},accept='image/*',label='Upload thumbnail image',required=${news.thumbnail==null},help='Thumbnail image',attachedFile=*{thumbnail})"&gt;&lt;/div&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>These are the needed parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>fieldName: the name of the field in the backing bean that holds the multipart file</p>
</li>
<li>
<p>size: the YadaIntDimension taken from the configuration, using the biggest between desktop and mobile</p>
</li>
<li>
<p>'accept': should be used to allow the upload of image files only. If a non-image is uploaded, it wouldn&#8217;t pass validation anyway</p>
</li>
<li>
<p>required: should be false when the YadaAttachedFile is not null so that the user is not forced to upload the file when changing something else in the Entity</p>
</li>
<li>
<p>attachedFile: the YadaAttachedFile if you want to show a link to the image below the input field (optional)</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_java_controller_to_show_the_form">Java Controller to show the form</h3>
<div class="paragraph">
<p>When showing the form using the fragment example, the <code>size</code> model attribute must be set:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">YadaIntDimension[] dimensionsDesktopAndMobile = config.getDimensionsNewsThumbnail();
YadaIntDimension biggestNeeded = YadaIntDimension.biggest(dimensionsDesktopAndMobile);
model.addAttribute("thumbnailSize", biggestNeeded);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_java_form_submission">Java Form submission</h3>
<div class="paragraph">
<p>When the Controller receives the submitted data inside an instance of the Entity, the first thing is to check for the upload file size, then issue an error when the file is too big:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@RequestMapping("/addOrUpdateNews")
public String addOrUpdateNews(News news, BindingResult newsBinding, HttpServletRequest request, Model model, Locale locale) {
    if (YadaCommonsMultipartResolver.limitExceeded(request)) {
        yadaNotify.title("News not saved", model).error().message("File too big. Size limit is " + config.getMaxFileUploadSizeBytes()/(1024*1024) + " MB").add();
        return "/manager/news";
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>If that check passes, the multipart should be extracted from the Entity because it won&#8217;t survive a save:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">MultipartFile thumbnailImage = news.getThumbnailImage(); // Can be null</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, the image size should be validated and when not big enough, the form should be returned with an error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">boolean valid = true;
YadaManagedFile thumbnailManagedFile = null;
YadaIntDimension[] thumbnailDimensionsDesktopMobile = null;
if (thumbnailImage!=null &amp;&amp; !thumbnailImage.isEmpty()) {
    try {
        thumbnailDimensionsDesktopMobile = config.getDimensionsNewsThumbnail();
        YadaIntDimension biggestNeeded = YadaIntDimension.biggest(thumbnailDimensionsDesktopMobile);
        thumbnailManagedFile = yadaFileManager.manageFile(thumbnailImage);
        YadaIntDimension fileDimension = thumbnailManagedFile.getDimension();
        if (fileDimension.isUnset()) {
            newsBinding.rejectValue("thumbnailImage", "validation.value.invalidImage", "Invalid image file");
            valid = false;
        } else if (biggestNeeded.isAnyBiggerThan(fileDimension)) {
            newsBinding.rejectValue("thumbnailImage", "validation.value.smallImage", new Object[] {fileDimension, biggestNeeded}, "Image too small");
            valid = false;
        }
    } catch (IOException e) {
        log.error("Error uploading image", e);
        newsBinding.rejectValue("thumbnailImage", "dashboard.imageupload.error");
        valid = false;
    }
}

if (!valid) {
	yadaFileManager.delete(thumbnailManagedFile);
    return EDIT_VIEW;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Entity should then be saved to store the new values, and the crop workflow can start.
It is possible to sequentially crop as many images as there are in the form. Images to be cropped are stored in the session.
It is important that, if the YadaSession object has been subclassed, it has the @Primary class annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Component
@Primary
@Scope(value="session", proxyMode=ScopedProxyMode.TARGET_CLASS)
public class ApplicationSession extends YadaSession&lt;UserProfile&gt; {</code></pre>
</div>
</div>
<div class="paragraph">
<p>Back to the Controller, the validated image can be added to the crop queue:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">boolean imageLoaded = false;
String cropRedirect = yadaWebUtil.redirectString("/manager/cropPage", locale);
String finalRedirect = yadaWebUtil.redirectString("/manager/journal", locale);
YadaCropQueue yadaCropQueue = applicationSession.addCropQueue(cropRedirect, finalRedirect); // Clear any previous abandoned crops and set the destination
if (thumbnailManagedFile!=null) {
    YadaCropImage yadaCropImage = yadaCropQueue.addCropImage(thumbnailManagedFile, thumbnailDimensionsDesktopMobile, FOLDER_NEWS, "thumb-");
    YadaAttachedFile newOrExisting = yadaCropImage.titleKey("crop.news.thumbnail").link(news.getThumbnail());
    news.setThumbnail(newOrExisting);
    imageLoaded=true;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>"/manager/cropPage"</code> and <code>"/manager/journal"</code> strings are, respectively, the url where the crop page is located and the url where the user should land
when all images in the queue have been cropped.
If the <code>YadaAttachedFile</code> is modified outside the <code>link</code> method, it should be put back into the <code>YadaCropImage</code> otherwise you&#8217;ll get a "ConcurrentModificationException" after crop:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">newOrExisting.setTitle(news.getTitle());
newOrExisting = yadaAttachedFileDao.save(newOrExisting);
yadaCropImage.setYadaAttachedFile(newOrExisting);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The final step is to redirect to the crop page:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">if (!imageLoaded) {
    applicationSession.deleteCropQueue();
} else {
    news = newsRepository.save(news);
    log.debug("Entering crop workflow for news");
    return yadaCropQueue.getCropRedirect();
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_html_crop_page">HTML Crop page</h3>
<div class="paragraph">
<p>The crop page can be easily implemented by including the <a href="https://jcrop.com/">jcrop library</a> and the yada imageCropper fragment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;head&gt;
    &lt;link rel="stylesheet" th:href="@{/static/jcrop-3/jcrop.css}"&gt;
    &lt;script th:src="@{/static/jcrop-3/jcrop.js}"&gt;&lt;/script&gt;
&lt;/head&gt;
&lt;body class="yadaCropPage"&gt;
    &lt;div class="container-fluid sec" th:with="cropQueue=${@applicationSession.cropQueue}, cropImage=${cropQueue.currentImage}"&gt;

        &lt;h1&gt;&lt;span th:text="#{${cropImage.titleKey}}"&gt;This is the title&lt;/span&gt;
        	&lt;span th:if="${cropQueue.totInitialImages&gt;1}"&gt; ([[#{crop.images.left(${cropQueue.count})}]])&lt;/span&gt;
        &lt;/h1&gt;
        &lt;p&gt;Drag the handles to the desired crop, then press the [[#{yada.crop.cropSubmit}]] button&lt;/p&gt;

        &lt;div th:replace="~{/yadacms/imageCropper::component(cropQueue=${cropQueue})}"&gt;&lt;/div&gt;

    &lt;/div&gt;
&lt;/body&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The actual crop of the image is already implemented in <code>YadaMiscController</code> so there&#8217;s nothing more to do.
To post the form to a custom crop method instead, call the <code>YadaCropQueue.setCropPerformAction()</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_troubleshooting">Troubleshooting</h3>
<div class="paragraph">
<p>The following exception: <code>YadaInvalidUsageException: Concurrent modification on yadaAttachedFile. This happens if you set 'cascade=CascadeType.ALL' on the owning entity or if the yadaAttachedFile is merged after setting it on YadaCropImage</code></p>
</div>
<div class="paragraph">
<p>is thrown whenever the YadaAttachedFile inside YadaCropImage is different from the one found on db at the time of the final crop.
This always happens in the following cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the Entity owning the YadaAttachedFile image has a <code>cascade=SAVE</code> on the attribute and it has been saved after calling <code>yadaCropImage.link()</code></p>
</li>
<li>
<p>the YadaAttachedFile has been saved after calling <code>yadaCropImage.link()</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Solution: do not use the offending cascade or re-add the new version of YadaAttachedFile to the YadaCropImage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">yadaCropImage.setYadaAttachedFile(yadaAttachedFile);</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 0.7.7<br>
Last updated 2024-06-06 13:20:10 +0200
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>